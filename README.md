# Payload E-Commerce Template

<svg width="124" height="30" viewBox="0 0 124 30" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M34.7441 23H37.2741V16.33H41.5981C44.7031 16.33 46.9801 14.904 46.9801 11.454C46.9801 8.004 44.7031 6.555 41.5981 6.555H34.7441V23ZM37.2741 14.145V8.74H41.4831C43.3921 8.74 44.3581 9.591 44.3581 11.454C44.3581 13.294 43.3921 14.145 41.4831 14.145H37.2741ZM51.3652 23.322C53.2742 23.322 54.6082 22.563 55.3672 21.344H55.4132C55.5512 22.678 56.1492 23.115 57.2762 23.115C57.6442 23.115 58.0352 23.069 58.4262 22.977V21.597C58.2882 21.62 58.2192 21.62 58.1502 21.62C57.7132 21.62 57.5982 21.183 57.5982 20.332V14.95C57.5982 11.914 55.6662 10.902 53.2512 10.902C49.6632 10.902 48.1912 12.673 48.0762 14.927H50.3762C50.4912 13.363 51.1122 12.719 53.1592 12.719C54.8842 12.719 55.3902 13.432 55.3902 14.283C55.3902 15.433 54.2632 15.663 52.4232 16.008C49.5022 16.56 47.5242 17.342 47.5242 19.964C47.5242 21.965 49.0192 23.322 51.3652 23.322ZM49.8702 19.803C49.8702 18.584 50.7442 18.009 52.8142 17.595C54.0102 17.342 55.0222 17.089 55.3902 16.744V18.423C55.3902 20.47 53.8952 21.505 51.8712 21.505C50.4682 21.505 49.8702 20.907 49.8702 19.803ZM61.4996 27.117C63.3166 27.117 64.4436 26.174 65.5706 23.276L70.2166 11.27H67.8476L64.6276 20.24H64.5816L61.1546 11.27H58.6936L63.4316 22.885C62.9716 24.725 61.9136 25.185 61.0166 25.185C60.6486 25.185 60.4416 25.162 60.0506 25.116V26.956C60.6486 27.071 60.9936 27.117 61.4996 27.117ZM71.5939 23H73.8479V6.555H71.5939V23ZM81.622 23.345C85.279 23.345 87.487 20.792 87.487 17.112C87.487 13.455 85.279 10.902 81.645 10.902C77.965 10.902 75.757 13.478 75.757 17.135C75.757 20.815 77.965 23.345 81.622 23.345ZM78.103 17.135C78.103 14.674 79.207 12.788 81.645 12.788C84.037 12.788 85.141 14.674 85.141 17.135C85.141 19.573 84.037 21.482 81.645 21.482C79.207 21.482 78.103 19.573 78.103 17.135ZM92.6484 23.322C94.5574 23.322 95.8914 22.563 96.6504 21.344H96.6964C96.8344 22.678 97.4324 23.115 98.5594 23.115C98.9274 23.115 99.3184 23.069 99.7094 22.977V21.597C99.5714 21.62 99.5024 21.62 99.4334 21.62C98.9964 21.62 98.8814 21.183 98.8814 20.332V14.95C98.8814 11.914 96.9494 10.902 94.5344 10.902C90.9464 10.902 89.4744 12.673 89.3594 14.927H91.6594C91.7744 13.363 92.3954 12.719 94.4424 12.719C96.1674 12.719 96.6734 13.432 96.6734 14.283C96.6734 15.433 95.5464 15.663 93.7064 16.008C90.7854 16.56 88.8074 17.342 88.8074 19.964C88.8074 21.965 90.3024 23.322 92.6484 23.322ZM91.1534 19.803C91.1534 18.584 92.0274 18.009 94.0974 17.595C95.2934 17.342 96.3054 17.089 96.6734 16.744V18.423C96.6734 20.47 95.1784 21.505 93.1544 21.505C91.7514 21.505 91.1534 20.907 91.1534 19.803ZM106.181 23.322C108.021 23.322 109.148 22.448 109.792 21.62H109.838V23H112.092V6.555H109.838V12.696H109.792C109.148 11.776 108.021 10.925 106.181 10.925C103.191 10.925 100.914 13.271 100.914 17.135C100.914 20.999 103.191 23.322 106.181 23.322ZM103.26 17.135C103.26 14.835 104.341 12.811 106.549 12.811C108.573 12.811 109.815 14.467 109.815 17.135C109.815 19.78 108.573 21.459 106.549 21.459C104.341 21.459 103.26 19.435 103.26 17.135Z" fill="currentColor"></path><g clip-path="url(#clip0_102_1302)"><g clip-path="url(#clip1_102_1302)"><path d="M12.2462 2.33875L22.2869 8.83849V21.1755L14.7263 25.8858V13.5488L4.67358 7.05762L12.2462 2.33875Z" fill="currentColor"></path><path d="M11.4765 25.2018V15.5748L3.8999 20.2937L11.4765 25.2018Z" fill="currentColor"></path></g></g><path d="M120.441 6.30297C119.086 6.30297 117.998 7.30002 117.998 8.75976C117.998 10.2065 119.086 11.197 120.441 11.197C121.79 11.197 122.879 10.2065 122.879 8.75976C122.879 7.30002 121.79 6.30297 120.441 6.30297ZM120.441 10.7604C119.34 10.7604 118.48 9.95231 118.48 8.75976C118.48 7.54766 119.34 6.73959 120.441 6.73959C121.562 6.73959 122.396 7.54766 122.396 8.75976C122.396 9.95231 121.562 10.7604 120.441 10.7604ZM120.52 8.97481L121.047 9.96534H121.64L121.041 8.86402C121.367 8.72066 121.51 8.45999 121.51 8.17326C121.51 7.49552 121.054 7.36519 120.285 7.36519H119.49V9.96534H120.024V8.97481H120.52ZM120.37 7.78877C120.728 7.78877 120.976 7.86697 120.976 8.17977C120.976 8.43392 120.806 8.56426 120.402 8.56426H120.024V7.78877H120.37Z" fill="currentColor"></path><defs><clipPath id="clip0_102_1302"><rect width="26" height="28" fill="white" transform="translate(0 0.685791)"></rect></clipPath><clipPath id="clip1_102_1302"><rect width="18.2" height="25.2" fill="white" transform="translate(3.8999 0.685791)"></rect></clipPath></defs></svg>

This is the official [Payload E-Commerce Template](https://github.com/payloadcms/payload/blob/main/templates/ecommerce). Use it to power e-commerce businesses and online stores of all sizes. This repo includes a fully-working backend, enterprise-grade admin panel, and a beautifully designed, production-ready website.

This template is right for you if you are selling:

- Physical products like clothing or merchandise
- Digital assets like ebooks or videos
- Access to content like courses or premium articles

Core features:

- [Pre-configured Payload Config](#how-it-works)
- [Authentication](#users-authentication)
- [Access Control](#access-control)
- [Shopping Cart](#shopping-cart)
- [Checkout](#checkout)
- [Paywall](#paywall)
- [Layout Builder](#layout-builder)
- [SEO](#seo)
- [Website](#website)

## Quick Start

To spin up this example locally, follow these steps:

### Clone

If you have not done so already, you need to have standalone copy of this repo on your machine. If you've already cloned this repo, skip to [Development](#development).

#### Method 1 (recommended)

  Go to Payload Cloud and [clone this template](https://payloadcms.com/new/clone/ecommerce). This will create a new repository on your GitHub account with this template's code which you can then clone to your own machine.

#### Method 2

  Use the `create-payload-app` CLI to clone this template directly to your machine:

    npx create-payload-app@latest my-project -t ecommerce

#### Method 3

  Use the `git` CLI to clone this template directly to your machine:

    git clone -n --depth=1 --filter=tree:0 https://github.com/payloadcms/payload my-project && cd my-project && git sparse-checkout set --no-cone templates/ecommerce && git checkout && rm -rf .git && git init && git add . && git mv -f templates/ecommerce/{.,}* . && git add . && git commit -m "Initial commit"

### Development

1. First [clone the repo](#clone) if you have not done so already
1. `cd my-project && cp .env.example .env` to copy the example environment variables
1. `yarn && yarn dev` to install dependencies and start the dev server
1. `open http://localhost:3000` to open the app in your browser

That's it! Changes made in `./src` will be reflected in your app. Follow the on-screen instructions to login and create your first admin user. To begin accepting payment, follow the [Stripe](#stripe) guide. Then check out [Production](#production) once you're ready to build and serve your app, and [Deployment](#deployment) when you're ready to go live.

## How it works

The Payload config is tailored specifically to the needs of most e-commerce businesses. It is pre-configured in the following ways:

### Collections

See the [Collections](https://payloadcms.com/docs/configuration/collections)  docs for details on how to extend this functionality.

- #### Users (Authentication)

  Users are auth-enabled and encompass both admins and customers based on the value of their `roles` field. Only `admin` users can access your admin panel to manage your store whereas `customer` can authenticate on your front-end to create [shopping carts](#shopping-cart) and place [orders](#orders) but have limited access to the platform. See [Access Control](#access-control) for more details.

  For additional help, see the official [Auth Example](https://github.com/payloadcms/payload/tree/main/examples/auth) or the [Authentication](https://payloadcms.com/docs/authentication/overview#authentication-overview) docs.

- #### Products

  Products are linked to Stripe via a custom select field that is dynamically populated in the sidebar of each product. This field fetches all available products in the background and displays them as options. Once a product has been selected, prices get automatically synced between Stripe and Payload through [Payload Hooks](https://payloadcms.com/docs/hooks) and [Stripe Webhooks](https://stripe.com/docs/webhooks). See [Stripe](#stripe) for more details.

  All products are layout builder enabled so you can generate unique pages for each product using layout building blocks, see [Layout Builder](#layout-builder) for more details.

  Products can also restrict access to content or digital assets behind a paywall (gated content), see [Paywall](#paywall) for more details.

- #### Orders

  Orders are created when a user successfully completes a checkout. They contain all the data about the order including the products purchased, the total price, and the user who placed the order. See [Checkout](#checkout) for more details.

- #### Pages

  All pages are layout builder enabled so you can generate unique layouts for each page using layout-building blocks, see [Layout Builder](#layout-builder) for more details.

- #### Media

  This is the uploads enabled collection used by products and pages to contain media like images, videos, downloads, and other assets.

- #### Categories

  A taxonomy used to group products together. Categories can be nested inside of one another, for example "Courses > Technology". See the official [Payload Nested Docs Plugin](https://github.com/payloadcms/plugin-nested-docs) for more details.

### Globals

See the [Globals](https://payloadcms.com/docs/configuration/globals) docs for details on how to extend this functionality.

- `Header`

  The data required by the header on your front-end like nav links.

- `Footer`

  Same as above but for the footer of your site.

## Access control

Basic role-based access control is setup to determine what users can and cannot do based on their roles, which are:

- `admin`: They can access the Payload admin panel to manage your store. They can see all data and make all operations.
- `customer`: They cannot access the Payload admin panel and can perform limited operations based on their user (see below).

This applies to each collection in the following ways:

- `users`: Only admins and the user themselves can access their profile. Anyone can create a user but only admins can delete users.
- `products`: Everyone can access products, but only admins can create, update, or delete them. Paywall-enabled products may also have content that is only accessible to only users who have purchased the product. See [Paywall](#paywall) for more details.

For more details on how to extend this functionality, see the [Payload Access Control](https://payloadcms.com/docs/access-control/overview#access-control) docs.

## Shopping cart

Logged-in users can have their shopping carts saved to their profiles as they shop. This way they can continue shopping at a later date or on another device. When not logged in, the cart can be saved to local storage and synced to Payload on the next login. This works by maintaining a `cart` field on the `user`:

```ts
{
  name: 'cart',
  label: 'Shopping Cart',
  type: 'object',
  fields: [
    {
      name: 'items',
      label: 'Items',
      type: 'array',
      fields: [
        // product, quantity, etc
      ]
    },
    // other metadata like `createdOn`, etc
  ]
}
```

## Stripe

Payload itself handles no currency exchange. All payments are processed and billed using [Stripe](https://stripe.com). This means you must have access to a Stripe account via an API key, see [Connect Stripe](#connect-stripe) for how to get one. When you create a product in Payload that you wish to sell, it must be connected to a Stripe product by selecting one from the field in the product's sidebar, see [Products](#products) for more details. Once set, data is automatically synced between the two platforms in the following ways:

1. Stripe to Payload using [Stripe Webhooks](https://stripe.com/docs/webhooks):
   - `product.created`
   - `product.updated`
   - `price.updated`

1. Payload to Stripe using [Payload Hooks](https://payloadcms.com/docs/hooks/overview):
   - `user.create`

For more details on how to extend this functionality, see the the official [Payload Stripe Plugin](https://github.com/payloadcms/plugin-stripe).

### Connect Stripe

To integrate with Stripe, follow these steps:

1. You will first need to create a [Stripe](https://stripe.com) account if you do not already have one.
1. Retrieve your [Stripe API keys](https://dashboard.stripe.com/test/apikeys) and paste them into your `env`:
   ```bash
   STRIPE_SECRET_KEY=
   NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
   ```
1. In another terminal, listen for webhooks (optional):
   ```bash
   stripe login # follow the prompts
   yarn stripe:webhooks
   ```
1. Paste the given webhook signing secret into your `env`:
   ```bash
   STRIPE_WEBHOOKS_SIGNING_SECRET=
   ```
1. Reboot Payload to ensure that Stripe connects and the webhooks are registered.

## Checkout

A custom endpoint is opened at `POST /api/create-payment-intent` which initiates the checkout process. This endpoint totals your cart and creates a [Stripe Payment Intent](https://stripe.com/docs/payments/payment-intents). The total price is recalculated on the server to ensure accuracy and security, and once completed, passes the `client_secret` back in the response for your front-end to finalize the payment. Once the payment has succeeded, an [Order](#orders) will be created in Payload with a `stripePaymentIntentID`. Each purchased product will be recorded to the user's profile, and the user's cart will be automatically cleared.

## Paywall

Products can optionally restrict access to content or digital assets behind a paywall. This will require the product to be purchased before it's data and resources are accessible. To do this, a `purchases` field is maintained on each user to track their purchase history:

```ts
{
  name: 'purchases',
  label: 'Purchases',
  type: 'array',
  fields: [
    {
      name: 'product',
      label: 'Product',
      type: 'relationship',
      relationTo: 'products',
    },
    // other metadata like `createdOn`, etc
  ]
}
```

Then, a `paywall` field is added to the `product` with `read` access control set to check for associated purchases. Every time a user requests a product, this will only return data to those who have purchased it:

```ts
{
  name: 'paywall',
  label: 'Paywall',
  type: 'blocks',
  access: {
    read: checkUserPurchases,
  },
  fields: [
    // assets
  ]
}
```


### Cache

Although Next.js includes a robust set of caching strategies out of the box, Payload Cloud proxies and caches all files through Cloudflare using the [Official Cloud Plugin](https://github.com/payloadcms/plugin-cloud). This means that Next.js caching is not needed and is disabled by default. If you are hosting your app outside of Payload Cloud, you can easily reenable the Next.js caching mechanisms by removing the `no-store` directive from all fetch requests in `./src/app/_api` and then removing all instances of `export const dynamic = 'force-dynamic'` from pages files, such as `./src/app/(pages)/[slug]/page.tsx`. For more details, see the official [Next.js Caching Docs](https://nextjs.org/docs/app/building-your-application/caching).

##  Development

To spin up this example locally, follow the [Quick Start](#quick-start). Then [Connect Stripe](#connect-stripe) to enable payments, and [Seed](#seed) the database with a few products and pages.

### Docker

Alternatively, you can use [Docker](https://www.docker.com) to spin up this template locally. To do so, follow these steps:

1. Follow [steps 1 and 2 from above](#development), the docker-compose file will automatically use the `.env` file in your project root
1. Next run `docker-compose up`
1. Follow [steps 4 and 5 from above](#development) to login and create your first admin user

That's it! The Docker instance will help you get up and running quickly while also standardizing the development environment across your teams.

### Seed

To seed the database with a few products and pages you can run `yarn seed`. This template also comes with a `GET /api/seed` endpoint you can use to seed the database from the admin panel.

> NOTICE: seeding the database is destructive because it drops your current database to populate a fresh one from the seed template. Only run this command if you are starting a new project or can afford to lose your current data.


### Conflicting routes

>In a monorepo when routes are bootstrapped to the same host, they can conflict with Payload's own routes if they have the same name. In our template we've named the Nextjs API routes to `next` to avoid this conflict.
>
>This can happen with any other routes conflicting with Payload such as `admin` and we recommend using different names for custom routes.
>Alternatively you can also rename Payload's own routes via the [configuration](https://payloadcms.com/docs/configuration/overview).

## Production

To run Payload in production, you need to build and serve the Admin panel. To do so, follow these steps:

1. Invoke the `payload build` script by running `yarn build` or `npm run build` in your project root. This creates a `./build` directory with a production-ready admin bundle.
1. Finally run `yarn serve` or `npm run serve` to run Node in production and serve Payload from the `./build` directory.
1. When you're ready to go live, see [Deployment](#deployment) for more details.

### Deployment

Before deploying your app, you need to:

1. Switch [your Stripe account to live mode](https://stripe.com/docs/test-mode) and update your [Stripe API keys](https://dashboard.stripe.com/test/apikeys). See [Connect Stripe](#connect-stripe) for more details.
1. Ensure your app builds and serves in production. See [Production](#production) for more details.

The easiest way to deploy your project is to use [Payload Cloud](https://payloadcms.com/new/import), a one-click hosting solution to deploy production-ready instances of your Payload apps directly from your GitHub repo. You can also deploy your app manually, check out the [deployment documentation](https://payloadcms.com/docs/production/deployment) for full details.
